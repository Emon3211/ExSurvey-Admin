<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExSurvey Your Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
        }
        .profile-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #edf2f7;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 500;
            color: #4a5568;
            width: 35%;
        }
        .info-value {
            color: #2d3748;
            text-align: right;
            width: 65%;
            font-weight: 600;
        }
        /* Modal and Password Specific Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .password-field-container {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">

    <header class="bg-white shadow-md w-full py-4 px-6 flex items-center justify-between sticky top-0 z-10">
        <div class="flex items-center space-x-3">
             <i class="fas fa-user-circle text-blue-600 text-3xl"></i> 
            <h1 class="text-2xl font-bold text-gray-800">Your Profile</h1>
        </div>
        <button onclick="history.back()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300">
            Back
        </button>
    </header>

    <main class="flex-grow flex flex-col items-center justify-center p-4 w-full max-w-2xl mx-auto">
        <div class="profile-card w-full p-8 mt-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Profile Information</h2>
            
            <div class="flex justify-center mb-6">
                <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-5xl">
                    <i class="fas fa-user"></i>
                </div>
            </div>

            <div id="profile-info" class="space-y-2">
                <div class="info-item">
                    <span class="info-label">Username:</span>
                    <span id="username-display" class="info-value">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Full Name:</span>
                    <span id="fullname-display" class="info-value">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Gender:</span>
                    <span id="gender-display" class="info-value">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Country:</span>
                    <span id="country-display" class="info-value">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Phone:</span>
                    <span id="phone-display" class="info-value">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email:</span>
                    <span id="email-display" class="info-value">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Address:</span>
                    <span id="address-display" class="info-value">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Zip Code:</span>
                    <span id="zipcode-display" class="info-value">Loading...</span>
                </div>
            </div>

            <div class="mt-10 flex justify-center">
                <button id="change-password-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
                    <i class="fas fa-key mr-2"></i> Change Password
                </button>
            </div>
        </div>
    </main>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Change Password</h3>
                <button id="close-modal-button" class="text-gray-500 hover:text-gray-800 transition duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="password-change-form" class="space-y-4">
                <div>
                    <label for="old-password" class="block text-gray-700 font-medium mb-1">Old Password</label>
                    <div class="password-field-container">
                        <input type="password" id="old-password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                        <i class="password-toggle fas fa-eye" data-target="old-password"></i>
                    </div>
                </div>
                <div>
                    <label for="new-password" class="block text-gray-700 font-medium mb-1">New Password</label>
                    <div class="password-field-container">
                        <input type="password" id="new-password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                        <i class="password-toggle fas fa-eye" data-target="new-password"></i>
                    </div>
                    <div id="password-validation" class="text-xs mt-2 text-gray-500">
                        <ul class="list-disc list-inside space-y-1">
                            <li id="length-check" class="text-red-500"><i class="fas fa-times-circle"></i> Minimum 8 characters</li>
                            <li id="number-check" class="text-red-500"><i class="fas fa-times-circle"></i> At least one number</li>
                            <li id="letter-check" class="text-red-500"><i class="fas fa-times-circle"></i> At least one letter</li>
                            <li id="symbol-check" class="text-red-500"><i class="fas fa-times-circle"></i> At least one symbol</li>
                        </ul>
                    </div>
                </div>
                <div>
                    <label for="retype-new-password" class="block text-gray-700 font-medium mb-1">Retype New Password</label>
                    <div class="password-field-container">
                        <input type="password" id="retype-new-password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                        <i class="password-toggle fas fa-eye" data-target="retype-new-password"></i>
                    </div>
                    <p id="password-match-error" class="text-red-500 text-sm mt-1 hidden">Passwords do not match.</p>
                </div>
                <button type="submit" id="update-password-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300">
                    Update Password
                </button>
                <div id="password-status-message" class="mt-4 text-center hidden"></div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, reauthenticateWithCredential, EmailAuthProvider, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCS5HN0yT3e7el75fBc2HLcLmTnrcQZ7bc",
            authDomain: "exsurvey-1c78a.firebaseapp.com",
            databaseURL: "https://exsurvey-1c78a-default-rtdb.firebaseio.com",
            projectId: "exsurvey-1c78a",
            storageBucket: "exsurvey-1c78a.firebasestorage.app",
            messagingSenderId: "754959615386",
            appId: "1:754959615386:web:65c390db232a7dafd3e623",
            measurementId: "G-8SQNS2DLBT"
        };
        const __initial_auth_token = 'YOUR_ADMIN_CUSTOM_TOKEN_HERE';

        let db, auth;
        let userId;

        const changePasswordButton = document.getElementById('change-password-button');
        const passwordModal = document.getElementById('password-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const passwordChangeForm = document.getElementById('password-change-form');
        const newPasswordInput = document.getElementById('new-password');
        const retypeNewPasswordInput = document.getElementById('retype-new-password');
        const lengthCheck = document.getElementById('length-check');
        const numberCheck = document.getElementById('number-check');
        const letterCheck = document.getElementById('letter-check');
        const symbolCheck = document.getElementById('symbol-check');
        const passwordMatchError = document.getElementById('password-match-error');
        const passwordStatusMessageDiv = document.getElementById('password-status-message');

        // Function to show status messages
        function showStatus(message, isError = false, element = passwordStatusMessageDiv) {
            element.textContent = message;
            element.classList.remove('hidden', 'text-green-600', 'text-red-600');
            element.classList.add(isError ? 'text-red-600' : 'text-green-600');
        }

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    fetchUserProfile(userId);
                } else {
                    if (__initial_auth_token && __initial_auth_token !== 'YOUR_ADMIN_CUSTOM_TOKEN_HERE') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        showStatus('Authentication failed. Please provide a valid custom token.', true);
                    }
                }
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showStatus('Failed to initialize Firebase. Check your configuration.', true);
        }

        // Fetch user data from Realtime Database
        async function fetchUserProfile(uid) {
            try {
                const userRef = ref(db, 'users/' + uid);
                const snapshot = await get(userRef);

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('username-display').textContent = data.username || 'N/A';
                    document.getElementById('fullname-display').textContent = data.fullname || 'N/A';
                    document.getElementById('gender-display').textContent = data.gender || 'N/A';
                    document.getElementById('country-display').textContent = data.country || 'N/A';
                    document.getElementById('phone-display').textContent = data.phone || 'N/A';
                    document.getElementById('email-display').textContent = data.email || 'N/A';
                    document.getElementById('address-display').textContent = data.address || 'N/A';
                    document.getElementById('zipcode-display').textContent = data.zipcode || 'N/A';
                } else {
                    // You can add a status message here if needed, but it's removed from the main view
                    console.log('User profile data not found.');
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
            }
        }
        
        // Modal and button event listeners
        changePasswordButton.addEventListener('click', () => {
            passwordModal.style.display = 'flex';
        });

        closeModalButton.addEventListener('click', () => {
            passwordModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === passwordModal) {
                passwordModal.style.display = 'none';
            }
        });

        // Password validation logic
        newPasswordInput.addEventListener('keyup', () => {
            const password = newPasswordInput.value;
            const hasLength = password.length >= 8;
            const hasNumber = /[0-9]/.test(password);
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/.test(password);
            
            function updateValidationUI(element, condition) {
                element.classList.remove('text-red-500', 'text-green-500');
                element.classList.add(condition ? 'text-green-500' : 'text-red-500');
                const icon = element.querySelector('i');
                icon.classList.remove('fa-times-circle', 'fa-check-circle');
                icon.classList.add(condition ? 'fa-check-circle' : 'fa-times-circle');
            }

            updateValidationUI(lengthCheck, hasLength);
            updateValidationUI(numberCheck, hasNumber);
            updateValidationUI(letterCheck, hasLetter);
            updateValidationUI(symbolCheck, hasSymbol);

            retypeNewPasswordInput.dispatchEvent(new Event('keyup'));
        });

        retypeNewPasswordInput.addEventListener('keyup', () => {
            if (newPasswordInput.value === retypeNewPasswordInput.value) {
                passwordMatchError.classList.add('hidden');
            } else {
                passwordMatchError.classList.remove('hidden');
            }
        });

        // Toggle password visibility
        document.querySelectorAll('.password-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const targetId = toggle.getAttribute('data-target');
                const targetInput = document.getElementById(targetId);
                const isPassword = targetInput.type === 'password';
                targetInput.type = isPassword ? 'text' : 'password';
                toggle.classList.toggle('fa-eye', !isPassword);
                toggle.classList.toggle('fa-eye-slash', isPassword);
            });
        });

        // Handle password change form submission
        passwordChangeForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const oldPassword = document.getElementById('old-password').value;
            const newPassword = newPasswordInput.value;
            const retypeNewPassword = retypeNewPasswordInput.value;

            if (newPassword !== retypeNewPassword) {
                showStatus('New passwords do not match.', true);
                return;
            }

            const hasLength = newPassword.length >= 8;
            const hasNumber = /[0-9]/.test(newPassword);
            const hasLetter = /[a-zA-Z]/.test(newPassword);
            const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/.test(newPassword);
            
            if (!hasLength || !hasNumber || !hasLetter || !hasSymbol) {
                showStatus('Password does not meet the validation requirements.', true);
                return;
            }

            if (auth.currentUser) {
                try {
                    const credential = EmailAuthProvider.credential(auth.currentUser.email, oldPassword);
                    await reauthenticateWithCredential(auth.currentUser, credential);
                    
                    await updatePassword(auth.currentUser, newPassword);
                    
                    showStatus('Password updated successfully!', false);
                    e.target.reset();
                    setTimeout(() => {
                        passwordModal.style.display = 'none';
                    }, 2000);

                } catch (error) {
                    let errorMessage = error.message;
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        errorMessage = 'The old password you entered is incorrect.';
                    } else if (error.code === 'auth/requires-recent-login') {
                         errorMessage = 'Please sign out and sign in again to change your password.';
                    }
                    showStatus('Failed to update password: ' + errorMessage, true);
                }
            } else {
                showStatus('User is not authenticated. Cannot change password.', true);
            }
        });

    </script>
</body>
</html>
