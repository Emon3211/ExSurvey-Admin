<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Pending Requests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: auto;
            margin-bottom: 20px;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
        }
        h1 {
            text-align: center;
            color: #333;
            margin: 0;
            flex-grow: 1;
        }
        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #555;
            text-decoration: none;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        ul {
            list-style: none;
            padding: 0;
        }
        .request-item {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .request-info {
            flex-grow: 1;
        }
        .request-info p {
            margin: 5px 0;
        }
        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .approve-btn, .reject-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .approve-btn {
            background-color: #28a745;
            color: white;
        }
        .reject-btn {
            background-color: #dc3545;
            color: white;
        }
        .status-message {
            text-align: center;
            margin-top: 20px;
        }
        .status-success {
            color: green;
        }
        .status-error {
            color: red;
        }
        .no-requests {
            text-align: center;
            color: #666;
            margin-top: 20px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="#" class="back-btn" onclick="goBack()">&#8592;</a>
        <h1>Deposit/Withdraw Pending Requests</h1>
    </div>
    <div id="status-message" class="status-message"></div>
    
    <ul id="request-list"></ul>
    <p id="no-requests-msg" class="no-requests" style="display: none;">No pending requests at the moment.</p>
</div>

<script>
    // Your Firebase Config (Make sure this matches your project)
    const firebaseConfig = {
      apiKey: "AIzaSyCS5HN0yT3e7el75fBc2HLcLmTnrcQZ7bc",
      authDomain: "exsurvey-1c78a.firebaseapp.com",
      databaseURL: "https://exsurvey-1c78a-default-rtdb.firebaseio.com",
      projectId: "exsurvey-1c78a",
      storageBucket: "exsurvey-1c78a.firebasestorage.app",
      messagingSenderId: "754959615386",
      appId: "1:754959615386:web:65c390db232a7dafd3e623",
      measurementId: "G-8SQNS2DLBT"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // UI Elements
    const requestList = document.getElementById('request-list');
    const statusMessage = document.getElementById('status-message');
    const noRequestsMsg = document.getElementById('no-requests-msg');

    // Fetch and display all pending requests
    function fetchPendingRequests() {
        const requestsRef = database.ref('deposit_withdraw_request').orderByChild('timestamp');
        
        requestsRef.on('value', (snapshot) => {
            requestList.innerHTML = '';
            let hasPendingRequests = false;
            
            const pendingRequests = [];
            snapshot.forEach((childSnapshot) => {
                const request = childSnapshot.val();
                if (request.status === 'pending' || request.status === 'Pending') {
                    pendingRequests.push({
                        id: childSnapshot.key,
                        data: request
                    });
                    hasPendingRequests = true;
                }
            });

            // Sort in descending order to show the newest on top
            pendingRequests.sort((a, b) => b.data.timestamp - a.data.timestamp);

            if (hasPendingRequests) {
                noRequestsMsg.style.display = 'none';
                pendingRequests.forEach((req) => {
                    const { id, data } = req;
                    const isDeposit = data.status === 'pending';
                    const itemType = isDeposit ? 'Deposit' : 'Withdrawal';
                    const buttonType = isDeposit ? 'deposit' : 'withdraw';

                    const date = new Date(data.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString();

                    const bdtAmount = data.bdtAmount || data.amount_bdt;

                    const li = document.createElement('li');
                    li.classList.add('request-item');
                    li.innerHTML = `
                        <div class="request-info">
                            <p><strong>Type:</strong> ${itemType}</p>
                            <p><strong>Username:</strong> ${data.username}</p>
                            <p><strong>Amount:</strong> $${data.amount}</p>
                            ${bdtAmount ? `<p><strong>BDT Amount:</strong> à§³ ${bdtAmount}</p>` : ''}
                            <p><strong>Method:</strong> ${data.method}</p>
                            ${data.transactionId ? `<p><strong>Transaction ID:</strong> ${data.transactionId}</p>` : ''}
                            ${data.accountNo ? `<p><strong>Account No:</strong> ${data.accountNo}</p>` : ''}
                            <p><strong>Date:</strong> ${formattedDate}</p>
                            <p><strong>Time:</strong> ${formattedTime}</p>
                        </div>
                        <div class="request-actions">
                            <button class="approve-btn" data-id="${id}" data-type="${buttonType}">Approve</button>
                            <button class="reject-btn" data-id="${id}" data-type="${buttonType}">Reject</button>
                        </div>
                    `;
                    requestList.appendChild(li);
                });
            } else {
                noRequestsMsg.style.display = 'block';
            }
        }, (error) => {
            console.error("Firebase Read Error:", error);
            statusMessage.textContent = 'Failed to load requests.';
            statusMessage.classList.add('status-error');
        });
    }

    // Handle button clicks (Approve/Reject)
    document.body.addEventListener('click', async (e) => {
        const button = e.target;
        if (button.classList.contains('approve-btn') || button.classList.contains('reject-btn')) {
            const requestId = button.dataset.id;
            const requestType = button.dataset.type;
            const action = button.classList.contains('approve-btn') ? 'approve' : 'reject';

            if (action === 'approve') {
                if (requestType === 'deposit') {
                    await approveDeposit(requestId);
                } else if (requestType === 'withdraw') {
                    await approveWithdrawal(requestId);
                }
            } else if (action === 'reject') {
                if (requestType === 'deposit') {
                    await rejectDeposit(requestId);
                } else if (requestType === 'withdraw') {
                    await rejectWithdrawal(requestId);
                }
            }
        }
    });

    // --- Deposit and Withdrawal functions (unchanged from previous code) ---

    async function approveDeposit(requestId) {
        statusMessage.textContent = 'Processing...';
        statusMessage.className = 'status-message';
        const requestRef = database.ref('deposit_withdraw_request/' + requestId);
        try {
            const snapshot = await requestRef.once('value');
            const requestData = snapshot.val();
            if (!requestData || requestData.status !== 'pending') {
                statusMessage.textContent = "Deposit request not found or already processed.";
                statusMessage.classList.add('status-error');
                return;
            }
            const { amount, username } = requestData;
            const usersRef = database.ref('users').orderByChild('username').equalTo(username);
            const userSnapshot = await usersRef.once('value');
            const userData = userSnapshot.val();
            if (!userData) {
                statusMessage.textContent = "User not found for this deposit. Rejecting.";
                statusMessage.classList.add('status-error');
                await requestRef.update({ status: 'rejected' });
                return;
            }
            const userId = Object.keys(userData)[0];
            const userRef = database.ref('users/' + userId);
            await userRef.transaction((currentData) => {
                if (currentData) {
                    const currentBalance = currentData.balance || 0;
                    currentData.balance = parseFloat(currentBalance) + parseFloat(amount);
                }
                return currentData;
            });
            await requestRef.update({ status: 'approved' });
            statusMessage.textContent = `Deposit of $${amount} for ${username} has been approved. Balance updated.`;
            statusMessage.classList.add('status-success');
        } catch (error) {
            console.error("Approval failed:", error);
            statusMessage.textContent = `Approval failed: ${error.message}`;
            statusMessage.classList.add('status-error');
        }
    }

    async function rejectDeposit(requestId) {
        statusMessage.textContent = 'Processing...';
        statusMessage.className = 'status-message';
        const requestRef = database.ref('deposit_withdraw_request/' + requestId);
        try {
            const snapshot = await requestRef.once('value');
            const requestData = snapshot.val();
            if (requestData && requestData.status === 'pending') {
                await requestRef.update({ status: 'rejected' });
                statusMessage.textContent = 'Deposit request has been rejected.';
                statusMessage.classList.add('status-success');
            } else {
                statusMessage.textContent = 'Deposit request not found or already processed.';
                statusMessage.classList.add('status-error');
            }
        } catch (error) {
            console.error("Rejection failed:", error);
            statusMessage.textContent = `Rejection failed: ${error.message}`;
            statusMessage.classList.add('status-error');
        }
    }

    async function approveWithdrawal(requestId) {
        statusMessage.textContent = 'Processing...';
        statusMessage.className = 'status-message';
        const requestRef = database.ref('deposit_withdraw_request/' + requestId);
        try {
            const snapshot = await requestRef.once('value');
            const requestData = snapshot.val();
            if (!requestData || requestData.status !== 'Pending') {
                statusMessage.textContent = "Withdrawal request not found or already processed.";
                statusMessage.classList.add('status-error');
                return;
            }
            const { amount, userId } = requestData;
            if (!userId) {
                statusMessage.textContent = "User ID not found in the withdrawal request.";
                statusMessage.classList.add('status-error');
                await requestRef.update({ status: 'Rejected' });
                return;
            }
            const userRef = database.ref('users/' + userId);
            const result = await userRef.transaction((currentData) => {
                if (currentData) {
                    const currentBalance = currentData.balance || 0;
                    if (parseFloat(currentBalance) >= parseFloat(amount)) {
                        currentData.balance = parseFloat(currentBalance) - parseFloat(amount);
                        return currentData;
                    } else {
                        return null;
                    }
                }
                return null;
            });
            if (result.committed) {
                await requestRef.update({ status: 'Approved' });
                statusMessage.textContent = `Withdrawal of $${amount} for ${requestData.username} has been approved. Balance updated.`;
                statusMessage.classList.add('status-success');
            } else {
                statusMessage.textContent = `Approval failed: Insufficient balance for user ${requestData.username}.`;
                statusMessage.classList.add('status-error');
                await requestRef.update({ status: 'Rejected - Insufficient Funds' });
            }
        } catch (error) {
            console.error("Approval failed:", error);
            statusMessage.textContent = `Approval failed: ${error.message}`;
            statusMessage.classList.add('status-error');
        }
    }

    async function rejectWithdrawal(requestId) {
        statusMessage.textContent = 'Processing...';
        statusMessage.className = 'status-message';
        const requestRef = database.ref('deposit_withdraw_request/' + requestId);
        try {
            const snapshot = await requestRef.once('value');
            const requestData = snapshot.val();
            if (requestData && requestData.status === 'Pending') {
                await requestRef.update({ status: 'Rejected' });
                statusMessage.textContent = 'Withdrawal request has been rejected.';
                statusMessage.classList.add('status-success');
            } else {
                statusMessage.textContent = 'Withdrawal request not found or already processed.';
                statusMessage.classList.add('status-error');
            }
        } catch (error) {
            console.error("Rejection failed:", error);
            statusMessage.textContent = `Rejection failed: ${error.message}`;
            statusMessage.classList.add('status-error');
        }
    }

    function goBack() {
        window.history.back();
    }

    fetchPendingRequests();
</script>

</body>
</html>
