<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel: Update Links</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: flex-start;
            margin-bottom: 20px;
        }
        .back-button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }
        .back-button:hover {
            background-color: #0056b3;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            max-width: 600px;
            width: 100%;
        }
        h2 {
            color: #007bff;
            text-align: center;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            border-color: #007bff;
            outline: none;
        }
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #218838;
        }
        /* Style for loading indicator */
        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #007bff;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div class="header">
        <button class="back-button" onclick="goBack()"><i class="fas fa-arrow-left" style="margin-right: 8px;"></i> Back</button>
    </div>

    <div class="container">
        <h2><i class="fas fa-link"></i> Admin Panel: Update Social Links</h2>
        <div id="message" class="message"></div>
        <div id="loading" style="display: none;">Checking Admin Status...</div>
        
        <form id="updateLinkForm" style="display: none;">
            <div class="form-group">
                <label for="facebook_page"><i class="fab fa-facebook"></i> Facebook Page URL (e.g., https://...):</label>
                <input type="url" id="facebook_page" required placeholder="Enter full URL starting with https://">
            </div>
            
            <div class="form-group">
                <label for="youtube_channel"><i class="fab fa-youtube"></i> YouTube Channel URL (e.g., https://...):</label>
                <input type="url" id="youtube_channel" required placeholder="Enter full URL starting with https://">
            </div>
            
            <div class="form-group">
                <label for="support_email"><i class="fas fa-envelope"></i> Support Email (e.g., support@...):</label>
                <input type="email" id="support_email" required placeholder="Enter full email address">
            </div>
            
            <div class="form-group">
                <label for="whatsapp_group"><i class="fab fa-whatsapp"></i> WhatsApp Group/Contact (e.g., full link or number):</label>
                <input type="text" id="whatsapp_group" required placeholder="Enter full group link or contact number">
            </div>

            <button type="submit"><i class="fas fa-save"></i> Update Data</button>
        </form>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ⚠️ Replace with your actual Firebase config
        const firebaseConfig = {
          apiKey: "AIzaSyCS5HN0yT3e7el75fBc2HLcLmTnrcQZ7bc",
          authDomain: "exsurvey-1c78a.firebaseapp.com",
          databaseURL: "https://exsurvey-1c78a-default-rtdb.firebaseio.com",
          projectId: "exsurvey-1c78a",
          storageBucket: "exsurvey-1c78a.firebasestorage.app",
          messagingSenderId: "754959615386",
          appId: "1:754959615386:web:65c390db232a7dafd3e623",
          measurementId: "G-8SQNS2DLBT"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // The main node for links is 'link'
        const linkRef = database.ref('link');
        const usersRef = database.ref('users');

        const form = document.getElementById('updateLinkForm');
        const messageElement = document.getElementById('message');
        const loadingElement = document.getElementById('loading');
        
        // 🟢 Back Button Functionality: Checks history and returns
        function goBack() {
            // Check if there is a previous history state to go back to
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // If there is no history, redirect to the dashboard (index.html)
                window.location.href = 'index.html'; 
            }
        }

        // --- ADMIN ACCESS CHECK ---
        auth.onAuthStateChanged(user => {
            loadingElement.style.display = 'block';
            form.style.display = 'none';

            if (!user) {
                showMessage("Access Denied. Please log in first.", "error");
                setTimeout(() => { window.location.href = 'index.html'; }, 3000);
                return;
            }

            // Check if the user's profile has 'admin: true'
            usersRef.child(user.uid).once('value')
                .then(snapshot => {
                    loadingElement.style.display = 'none';
                    const userData = snapshot.val();
                    
                    if (userData && userData.is_admin === true) {
                        // User is Admin, allow access
                        form.style.display = 'block';
                        // 🟢 Load current links into the form fields
                        loadCurrentLinks(); 
                    } else {
                        // Not an Admin
                        showMessage("Authorization Failed. You do not have administrator privileges.", "error");
                        setTimeout(() => { window.location.href = 'index.html'; }, 3000);
                    }
                })
                .catch(error => {
                    loadingElement.style.display = 'none';
                    showMessage("Error checking user privileges: " + error.message, "error");
                });
        });

        // --- Load Current Data from 'link' Node and populate form ---
        function loadCurrentLinks() {
            linkRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    // 🟢 Populating fields with current data
                    document.getElementById('facebook_page').value = data.facebook_page || '';
                    document.getElementById('youtube_channel').value = data.youtube_channel || '';
                    document.getElementById('support_email').value = data.support_email || '';
                    document.getElementById('whatsapp_group').value = data.whatsapp_group || '';
                }
                // showMessage("Current links loaded successfully.", "success");
            }).catch(error => {
                console.error("Error loading links:", error);
                showMessage("Error loading current links: " + error.message, "error");
            });
        }

        // --- Form Submission and Data Update ---
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            if (!auth.currentUser) return;

            const updatedData = {
                facebook_page: document.getElementById('facebook_page').value,
                youtube_channel: document.getElementById('youtube_channel').value,
                support_email: document.getElementById('support_email').value,
                whatsapp_group: document.getElementById('whatsapp_group').value
            };

            linkRef.update(updatedData)
                .then(() => {
                    showMessage("✅ All links successfully updated!", "success");
                })
                .catch(error => {
                    console.error("Error updating links:", error);
                    showMessage("❌ Error updating links: " + error.message, "error");
                });
        });

        // --- Display Message Function ---
        function showMessage(msg, type) {
            messageElement.textContent = msg;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
